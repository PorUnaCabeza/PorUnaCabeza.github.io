<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">

    <title>jsoup学习笔记(三):模拟登录 - Namárië</title>

    <link rel="canonical" href="fdgdfgfdg/blog/2016/01/23/jsoup-learning-note-3/">

    <!-- Icons -->
  <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
   

</head>






<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Namárië</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">关于我</a>
                </li>
                
                <li>
                    <a href="/archive/">列表</a>
                </li>
                
                <li>
                    <a href="/tags/">标签</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<style type="text/css">
    header.intro-header{
		background-color:#678
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="Tags">
                        
                        <a class="tag" style="" href="/tags/#java" title="java">java</a>
                        
                        <a class="tag" style="" href="/tags/#jsoup" title="jsoup">jsoup</a>
                        
                        <a class="tag" style="" href="/tags/#html" title="html">html</a>
                        
                    </div>
                    <h1>jsoup学习笔记(三):模拟登录</h1>
                    
                    <span class="meta">Posted by cabeza on January 23, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>




<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container">

                <blockquote>
  <p>如上文所述，未登录状态爬取信息时会有很多限制，那么就来看看如何模拟登录知乎</p>
</blockquote>

<h3 id="cookie">采用最暴力的方法：硬塞cookie</h3>

<p>首先，在浏览器上登录帐号，然后提取到cookie</p>

<p>关于如何获取，各个浏览器不一样，可以针对自己的百度下</p>

<p>拿到cookie值后，在程序里硬编码写入</p>

<pre><code>Connection con = Jsoup.connect("https://www.zhihu.com");//获取连接
con.header("User-Agent", "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:29.0) Gecko/20100101 Firefox/29.0");//配置模拟浏览器
Map&lt;String, String&gt; cookie = new HashMap&lt;&gt;();
cookie.put("_xsrf", "af8cfcba675ae98ae5a6e238b2844238");
cookie.put("_za", "7699d7fa-905b-44bf-9a08-583ca27692b3");
cookie.put("__utma", "51854390.1095779136.1452616328.1452616328.1452616328.1");
cookie.put("__utmb", "51854390.14.10.1452616328");
cookie.put("__utmc", "51854390");
//...许多cookie，省略
con.cookies(cookie);
Connection.Response rs = con.execute();
Document doc = Jsoup.parse(rs.body());
System.out.println(doc);
</code></pre>

<p>结果如之前所料，是已登录的状态</p>

<p>此方法只是权宜之计，比如临时写一个只会用几次的爬虫程序</p>

<h3 id="section">模拟登录知乎</h3>

<p>下面一步步分析</p>

<h4 id="section-1">1.请求地址</h4>
<p>使用chrome开发者工具中的network功能抓取：</p>

<blockquote>
  <p>Request URL:https://www.zhihu.com/login/email</p>
</blockquote>

<h4 id="section-2">2.需要哪些字段</h4>

<p>打开知乎首页，观察登录表单</p>

<p>帐号密码输入框、验证码输入框</p>

<p>随便填几个值，点登录，使用chrome开发者工具中的network功能抓取请求头form data：</p>

<pre><code>_xsrf:88d1ff7fd5a1f66f306b8f720a7322b8
password:123456
captcha:1234
remember_me:true
email:12345678
</code></pre>

<p>发现五个字段</p>

<ul>
  <li>_xsrf，暂时不知道作用，猜测是一种验证机制</li>
  <li>email、password，见名知意，帐号密码</li>
  <li>remember，是否记住帐号</li>
  <li>captcha，验证码值</li>
</ul>

<p>只有_xsrf不知其意，查看网页源代码，发现</p>

<pre><code>&lt;input type="hidden" name="_xsrf" value="88d1ff7fd5a1f66f306b8f720a7322b8"&gt;
</code></pre>

<p>ok，管你是什么意思，我先发一次请求拿到你，第二次的时候直接塞进去不就得了
如码所示：</p>

<pre><code>public void getXsrf() {
		con = Jsoup.connect("http://www.zhihu.com");
		con.header("User-Agent", userAgent);
		try {
			rs = con.execute();
		} catch (Exception e) {
			log.info("获得Xsrf失败");
			return;
		}
		Document doc=Jsoup.parse(rs.body());
		_xsrf=doc.select(".view.view-signin [name=\"_xsrf\"]").attr("value");
		log.info("已获得xsrf");
	}
</code></pre>

<h4 id="section-3">3.如何获取验证码</h4>

<p>查看网页源代码</p>

<pre><code>&lt;img class="js-refresh-captcha captcha" width="120" height="30" data-tip="s$t$看不清楚？换一张" alt="验证码" src="/captcha.gif?r=1453549553883"&gt;
</code></pre>

<p>得到验证码地址：</p>

<blockquote>
  <p>www.zhihu.com/captcha.gif?r=一些数字</p>
</blockquote>

<p>很容易可以看出，r的值为Unix时间戳</p>

<p>下一步，代码实现下载验证码到本地，并保存该验证码的cookie，为后面登录做准备</p>

<pre><code>private Map&lt;String,String&gt; captchaCookies =new HashMap&lt;&gt;();
....
public void getCaptcha() {
		captchaCookies.clear();
		log.info(System.currentTimeMillis());
		con = Jsoup.connect("https://www.zhihu.com/captcha.gif?r=" + System.currentTimeMillis()).ignoreContentType(true);//获取连接
		con.header("User-Agent", userAgent);
		try {
			rs = con.execute();
		} catch (Exception e) {
			log.info("获得验证码cookie失败");
			return;
		}
		File file = new File("cabeza.gif");
		try {
			FileOutputStream out = (new FileOutputStream(file));
			out.write(rs.bodyAsBytes());
		} catch (IOException e) {
			e.printStackTrace();
		}
		captchaCookies.putAll(rs.cookies());
		log.info("验证码已保存" + ",路径为:" + file.getAbsolutePath());
	}
</code></pre>

<p>验证码和对应cookie拿到后，下面就是登录了</p>

<h4 id="section-4">4.根据上述五个字段，实现登录</h4>

<pre><code>public void getLoginCookies() {
    loginCookies.clear();
    Scanner sc=new Scanner(System.in);
    getXsrf();	//获取_xsrf
    getCaptchaCookies();	//获取验证码和验证码cookie
    log.info("请输入帐号");
    String userName=sc.nextLine();
    log.info("请输入密码");
    String passWord=sc.nextLine();
    log.info("请打开工程路径查看验证码并输入");
    String captcha=sc.nextLine();
    con = Jsoup.connect("https://www.zhihu.com/login/email");
    con.header("User-Agent", userAgent);
    try {
        rs = con.ignoreContentType(true).method(Connection.Method.POST)
                .data("_xsrf", _xsrf)
                .data("email", userName)
                .data("password", passWord)
                .data("captcha", captcha).cookies(captchaCookies).execute();
    } catch (Exception e) {
        log.info("获得loginCookies失败");
        return;
    }
    loginCookies.putAll(rs.cookies());
}
</code></pre>

<h4 id="section-5">5.一些后续工作</h4>
<p>拿到登录cookie后，为了方便下次登录，可以将cookie保存到文件，下次先从文件读取cookie登录，若失败，再使用上文方法登录</p>

<pre><code>public void saveCookies(String fileName, Map&lt;String, String&gt; cookies) {
    FileOutputStream fos = null;
    try {
        fos = new FileOutputStream(fileName);
    } catch (IOException e) {
        e.printStackTrace();
    }
    BufferedOutputStream bos
            = new BufferedOutputStream(fos);
    PrintWriter pw = new PrintWriter(bos);
    for (Map.Entry&lt;String, String&gt; entry : cookies.entrySet()) {
        pw.println(entry.getKey() + "=" + entry.getValue().replace("\"",""));
    }
    pw.close();
    log.info("cookies已保存");
}
public void readCookies(String filename) {
    loginCookies.clear();
    try {
        FileInputStream fis
                = new FileInputStream(filename);
        InputStreamReader isr
                = new InputStreamReader(fis);
        BufferedReader br
                = new BufferedReader(isr);
        String str = null;
        while ((str = br.readLine()) != null) {
            int index = str.indexOf("=");
            loginCookies.put(
                    str.substring(0, index),
                    str.substring(index + 1, str.length())
            );
        }
    } catch (IOException e) {
        e.printStackTrace();
    }
    log.info(loginCookies);
}
</code></pre>

<p>从文件读取cookie登录</p>

<pre><code>public boolean loginBySavedCookies() {
    readCookies("zhihu_cookies.txt");
    con = Jsoup.connect("https://www.zhihu.com");//获取连接
    con.header("User-Agent", userAgent);//配置模拟浏览器
    con.cookies(loginCookies);
    try {
        rs = con.execute();
    } catch (Exception e) {
        log.info("读取Cookie登录失败");
        return false;
    }
    Document doc = Jsoup.parse(rs.body());
    if (checkLogin(doc))
        return true;
    log.info("读取cookie登录失败,下面手动登录:");
    return login();
}
</code></pre>

<p>至此，一个简单的模拟登录程序就完成了</p>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/blog/2016/01/19/jsoup-learning-note-2/" data-toggle="tooltip" data-placement="top" title="jsoup学习笔记(二):读取知乎个人首页动态">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/blog/2016/01/30/jsoup-learning-note-4/" data-toggle="tooltip" data-placement="top" title="jsoup学习笔记(四):监控动态与爬取所有动态">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- Duoshuo Share start -->
                <style>
                    .ds-share{
                        text-align: right;
                    }
                    
                    @media only screen and (max-width: 700px) {
                        .ds-share {

                        }
                    }
                </style>

                <div class="ds-share"
                    data-thread-key="/blog/2016/01/23/jsoup-learning-note-3" data-title="jsoup学习笔记(三):模拟登录"
                    data-images="fdgdfgfdg/img/facebook.jpg"
                    data-content="
  如上文所述，未登录状态爬取信息时会有很多限制，那么就来看看如何模拟登录知乎


采用最暴力的方法：硬塞cookie

首先，在浏览器上登录帐号，然后... | Cabeza's blog"
                    data-url="fdgdfgfdg/blog/2016/01/23/jsoup-learning-note-3/">
                    <div class="ds-share-inline">
                      <ul  class="ds-share-icons-16">

                        <li data-toggle="ds-share-icons-more"><a class="ds-more" href="#">分享到：</a></li>
                        <li><a class="ds-wechat flat" href="javascript:void(0);" data-service="wechat">微信</a></li>
                        <li><a class="ds-weibo flat" href="javascript:void(0);" data-service="weibo">微博</a></li>
                        <li><a class="ds-douban flat" href="javascript:void(0);" data-service="douban">豆瓣</a></li>
                      </ul>
                      <div class="ds-share-icons-more">
                      </div>
                    </div>
                <hr>
                </div>
                <!-- Duoshuo Share end-->


                <!-- 多说评论框 start -->
                <div class="comment">
                    <div class="ds-thread" data-thread-key="/blog/2016/01/23/jsoup-learning-note-3" data-title="jsoup学习笔记(三):模拟登录" data-url="fdgdfgfdg/blog/2016/01/23/jsoup-learning-note-3/"></div>
                </div>
                <!-- 多说评论框 end -->
            </div>
        </div>
    </div>
</article>



<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"cabeza"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!-- 多说公共JS代码 end -->

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("http://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <!-- kill the Facebook and Weibo -->
					
                    

                    
                    
                    <!--
                    
                    -->

                    <!--
                    
                    -->

                    
                    <!--
                    
                    -->

                </ul>
                <p class="copyright text-muted">
                &copy; 2016  cabeza ❖ Powered by Jekyll.
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>



<!-- Highlight.js -->
<script>
    async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js",function(){
        hljs.initHighlightingOnLoad();
    })
</script>
<link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">


</body>

</html>