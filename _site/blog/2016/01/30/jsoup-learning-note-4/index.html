<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">

    <title>jsoup学习笔记(四):监控动态与爬取所有动态 - Namárië</title>

    <link rel="canonical" href="cabeza.cn/blog/2016/01/30/jsoup-learning-note-4/">

    <!-- Icons -->
  <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
   

</head>






<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Namárië</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">关于我</a>
                </li>
                
                <li>
                    <a href="/archive/">列表</a>
                </li>
                
                <li>
                    <a href="/tags/">标签</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<style type="text/css">
    header.intro-header{
		background-color:#678
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="Tags">
                        
                        <a class="tag" style="" href="/tags/#java" title="java">java</a>
                        
                        <a class="tag" style="" href="/tags/#jsoup" title="jsoup">jsoup</a>
                        
                        <a class="tag" style="" href="/tags/#html" title="html">html</a>
                        
                    </div>
                    <h1>jsoup学习笔记(四):监控动态与爬取所有动态</h1>
                    
                    <span class="meta">Posted by cabeza on January 30, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>




<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container">

                <blockquote>
  <p>今日公司年会，微醺</p>
</blockquote>

<p>在成功登录后，就可以搞一些好玩的事情了</p>

<p>比如知乎没有提供特别关心某用户的功能，我们可以自己做一个，当关注的用户有新的动态时，发送邮件提醒我们</p>

<p>或者，爬取某用户的所有动态，来分析他的喜好习惯</p>

<h3 id="section">监控动态</h3>

<h4 id="dom">1、分析dom，提取信息</h4>

<p>首先分析个人主页的dom结构</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;div class="zm-profile-section-list profile-feed-wrap"&gt;
	&lt;div id="zh-profile-activity-page-list"&gt;
		&lt;div class="zm-profile-section-item zm-item clearfix" data-time="1454573143" data-type="a" data-type-detail="member_voteup_answer"&gt;
		...
		&lt;/div&gt;
	&lt;/div&gt;
&lt;/div&gt;
</code></pre>
</div>

<p>具体的结构因为太长不太方便展现，可以到知乎去看下</p>

<p>经过观察，每一条动态都是在”zm-profile-section-item zm-item clearfix”类中的</p>

<p>其中data-time为unix时间戳</p>

<p>接着需要得到该动态的题目</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;div class="zm-profile-section-main zm-profile-section-activity-main zm-profile-activity-page-item-main"&gt;
	赞同了回答
	&lt;a class="question_link" target="_blank" href="/question/36305720/answer/67332034"&gt;如果上古卷轴5成为中学必修课会怎样?&lt;/a&gt;
&lt;/div&gt;
</code></pre>
</div>

<p>通过select(‘.zm-profile-activity-page-item-main’).text()可以拿到</p>

<p>该动态的链接 select(“.zm-profile-activity-page-item-main &gt; a”).last().attr(“abs:href”)</p>

<p>大概是这个样子：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Elements elmts = doc.select(".zm-profile-section-item.zm-item.clearfix");
    for (Element elmt : elmts) {
		String time=elmt.attr("data-time");
		String name=elmt.select(".zm-profile-activity-page-item-main").text();
		String href=elmt.select(".zm-profile-activity-page-item-main &gt; a").last().attr("abs:href");
    }
</code></pre>
</div>

<h4 id="section-1">2、判断最新动态</h4>

<p>上面提到data-time内为该动态的unix时间戳，那么记录下当前最新的data-time，在下一次拉取时，用该次的
所有data-time与上一次的最新data-time进行比较，大于上一次的皆为新增动态</p>

<p>定义一个recentNewsTime记录当前最新data-time</p>

<div class="highlighter-rouge"><pre class="highlight"><code>recentNewsTime=elmts.get(0).attr("data-time");
</code></pre>
</div>

<p>定义一个updateNews来记录最新动态列表
每次拉取时：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>if(elmt.attr("data-time").compareTo(recentNewsTime)&gt;0)
	updateNews.put(...);
</code></pre>
</div>

<h4 id="section-2">3、发送邮件</h4>

<p>使用javax.mail包来实现，没啥好讲的，看看api就行</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public void sendMail(Map&lt;String,String&gt; news) {
    Properties props=new Properties();
    try {
        ClassLoader loader = ZhihuUtil.class.getClassLoader();
        InputStream in = loader.getResourceAsStream("mailConfig.properties");
        props.load(in);
        System.out.println(props);
    } catch (FileNotFoundException e) {
        e.printStackTrace();
    } catch (IOException e) {
        e.printStackTrace();
    }
    Session session = Session.getInstance(props);
    Transport ts = null;
    try {
        ts = session.getTransport();
        ts.connect(props.getProperty("mail.smtp.host"), props.getProperty("username"), props.getProperty("password"));
        MimeMessage message = new MimeMessage(session);
        //发件人
        message.setFrom(new InternetAddress("makpia@163.com"));
        //收件人
        message.setRecipient(Message.RecipientType.TO, new InternetAddress("makpia@163.com"));
        message.setSubject(sdf.format(System.currentTimeMillis()) + "有新动态");
        emailContent.setLength(0);
        for (Map.Entry&lt;String, String&gt; entry : news.entrySet()) {
            date.setTime(Long.parseLong(entry.getKey()) * 1000);
            emailContent.append(sdf.format(date)+entry.getValue()+"&lt;br&gt;");
        }
        message.setContent(emailContent.toString(), "text/html;charset=UTF-8");
        ts.sendMessage(message, message.getAllRecipients());
        log.info("邮件发送成功!");
    } catch (Exception e) {
        log.info("发送邮件失败,请检查邮件配置");
        e.printStackTrace();
    } finally {
        try {
            ts.close();
        } catch (MessagingException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
</div>

<h3 id="section-3">爬取所有动态</h3>

<p>跟上文的监控动态很相似，不同的是需要分析点击“更多”时发送的请求与返回的信息</p>

<div class="highlighter-rouge"><pre class="highlight"><code>请求url
Request URL:https://www.zhihu.com/people/excited-vczh/activities
Request Method:POST
参数
Form Date:
start:1457128047
_xsrf:00662dfea71523ebea00cebcfca083ff
</code></pre>
</div>

<p>请求的参数中，start指的是点击“更多”时当前展示的最后一条动态的unix时间戳，该值可以从页面dom元素中获取：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>elmts = doc.select(".zm-profile-section-item.zm-item.clearfix");
    while(!elmts.isEmpty()){
        for (Element elmt : elmts) {
			//...
            traverseStartSign = elmt.attr("data-time");
        }
</code></pre>
</div>

<p>_xsrf在前面文章中提到过，猜测是一种验证机制，用登陆时保存的值即可</p>

<div class="highlighter-rouge"><pre class="highlight"><code>con = Jsoup.connect(url + "/activities").method(Connection.Method.POST).timeout(3000).ignoreContentType(true);//获取连接
        con.header("User-Agent", userAgent);//配置模拟浏览器
        con.data("start", traverseStartSign).data("_xsrf", _xsrf);
</code></pre>
</div>

<p>再来返回的信息：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="nt">"r"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
 </span><span class="nt">"msg"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="s2">"&lt;div class=\"zm-profile-section-item zm-item clearfix\" data-time=\"1457128021\" data-type=\"a\" data-type-detail=\"member_voteup_answer\"&gt;\n&lt;span class=\"zm-profile-setion-time zg-gray zg-right\"&gt;7 \u5c0f\u65f6\u524d&lt;\/span&gt;\n....后面东西太多，不展示了"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>可以看到返回的是一个json串，其中msg为时间戳start之后的动态信息，</p>

<p>\uxxxx这种格式是Unicode写法，表示一个字符，例如\u5c0f表示汉语中的‘小’字。</p>

<p>为了解析json串，需要引入json相关的包</p>

<div class="highlighter-rouge"><pre class="highlight"><code>JSONObject jsonObj=JSONObject.fromString(rs.body());
doc=Jsoup.parse(jsonObj.getJSONArray("msg").get(1).toString());
</code></pre>
</div>

<p>得到的doc就是新动态的dom信息，接着像监控动态里分析dom，提取信息即可</p>

<p>分析得到的dom后，继续判断当前展示的最后一条动态的unix时间戳、发送请求、得到返回的dom结构，如是往复，即可遍历所有动态</p>



                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/blog/2016/01/23/jsoup-learning-note-3/" data-toggle="tooltip" data-placement="top" title="jsoup学习笔记(三):模拟登录">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/blog/2016/02/28/datatable-learning-note-1/" data-toggle="tooltip" data-placement="top" title="Datatables学习小记">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- Duoshuo Share start -->
                <style>
                    .ds-share{
                        text-align: right;
                    }
                    
                    @media only screen and (max-width: 700px) {
                        .ds-share {

                        }
                    }
                </style>

                <div class="ds-share"
                    data-thread-key="/blog/2016/01/30/jsoup-learning-note-4" data-title="jsoup学习笔记(四):监控动态与爬取所有动态"
                    data-images="cabeza.cn/img/facebook.jpg"
                    data-content="
  今日公司年会，微醺


在成功登录后，就可以搞一些好玩的事情了

比如知乎没有提供特别关心某用户的功能，我们可以自己做一个，当关注的用户有新的动态时... | Cabeza's blog"
                    data-url="cabeza.cn/blog/2016/01/30/jsoup-learning-note-4/">
                    <div class="ds-share-inline">
                      <ul  class="ds-share-icons-16">

                        <li data-toggle="ds-share-icons-more"><a class="ds-more" href="#">分享到：</a></li>
                        <li><a class="ds-wechat flat" href="javascript:void(0);" data-service="wechat">微信</a></li>
                        <li><a class="ds-weibo flat" href="javascript:void(0);" data-service="weibo">微博</a></li>
                        <li><a class="ds-douban flat" href="javascript:void(0);" data-service="douban">豆瓣</a></li>
                      </ul>
                      <div class="ds-share-icons-more">
                      </div>
                    </div>
                <hr>
                </div>
                <!-- Duoshuo Share end-->


                <!-- 多说评论框 start -->
                <div class="comment">
                    <div class="ds-thread" data-thread-key="/blog/2016/01/30/jsoup-learning-note-4" data-title="jsoup学习笔记(四):监控动态与爬取所有动态" data-url="cabeza.cn/blog/2016/01/30/jsoup-learning-note-4/"></div>
                </div>
                <!-- 多说评论框 end -->
            </div>
        </div>
    </div>
</article>



<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"cabeza"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!-- 多说公共JS代码 end -->

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("http://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <!-- kill the Facebook and Weibo -->
					
                    

                    
                    
                    <!--
                    
                    -->

                    <!--
                    
                    -->

                    
                    <!--
                    
                    -->

                </ul>
                <p class="copyright text-muted">
                &copy; 2016  cabeza ❖ Powered by Jekyll.
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>



<!-- Highlight.js -->
<script>
    async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js",function(){
        hljs.initHighlightingOnLoad();
    })
</script>
<link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">


</body>

</html>