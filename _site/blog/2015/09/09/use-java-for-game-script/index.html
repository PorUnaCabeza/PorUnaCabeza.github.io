<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
	<meta name="baidu-site-verification" content="KG8VhCeHki" />


    <title>使用java写个简单游戏脚本（二）：JNI - Namárië</title>

    <link rel="canonical" href="cabeza.cn/blog/2015/09/09/use-java-for-game-script/">

    <!-- Icons -->
  <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
   

</head>






<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Namárië</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">关于我</a>
                </li>
                
                <li>
                    <a href="/archive/">列表</a>
                </li>
                
                <li>
                    <a href="/tags/">标签</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script type="text/javascript">(function(){document.write(unescape('%3Cdiv id="bdcs"%3E%3C/div%3E'));var bdcs = document.createElement('script');bdcs.type = 'text/javascript';bdcs.async = true;bdcs.src = 'http://znsv.baidu.com/customer_search/api/js?sid=2182260029629862282' + '&plate_url=' + encodeURIComponent(window.location.href) + '&t=' + Math.ceil(new Date()/3600000);var s = document.getElementsByTagName('script')[0];s.parentNode.insertBefore(bdcs, s);})();</script>


    <!-- Post Header -->
<style type="text/css">
    header.intro-header{
		background-color:#678
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="Tags">
                        
                        <a class="tag" style="" href="/tags/#java" title="java">java</a>
                        
                        <a class="tag" style="" href="/tags/#游戏" title="游戏">游戏</a>
                        
                    </div>
                    <h1>使用java写个简单游戏脚本（二）：JNI</h1>
                    
                    <span class="meta">Posted by cabeza on September 9, 2015</span>
                </div>
            </div>
        </div>
    </div>
</header>




<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container">

                <blockquote>
  <p>上一次的小程序只是演示了一下如何用robot类控制鼠标键盘操作</p>

  <p>这种方法有很大的弊端：1、不能后台运行。2、坐标代码写死，窗口甚至都不可移动。3、某些游戏会屏蔽该类
下面讲述下如何用JNI技术实现游戏内脚本后台执行</p>
</blockquote>

<h3 id="jni">什么是JNI</h3>
<p>简单讲就是实现了java和其他语言的通信，下面要用到是c或c++</p>

<p><a href="http://baike.baidu.com/link?url=CMSZ7ybpBNF4ajNimLQfbiNAJXZS-66dLhw98oK1S6cJpwN9yMxZ-7weEuzx05nvFGY19bLXHR2AAFbdeo2C1K">JNI</a>自行阅读，不赘述</p>

<p><em>另：不到万不得已不要使用JNI，一方面它需要你掌握更多的知识才可以驾驭，一方面使用了JNI你的程序就会丧失可移植性</em></p>

<h3 id="jni-1">为什么要用JNI</h3>
<p>java本身无法获得windows的接口，如窗口句柄等，需要借助c或c++</p>

<h3 id="java">java代码</h3>

<pre><code>
public class TowerUtil {
	public static native void keyPress(int hwnd, int key);
	public static native void mouseClick(int hwnd,int x,int y);
	static{
		System.loadLibrary("towerutil");
	}
	public static void main(String[] args) {
        int hwnd=1050990;
		TowerUtil.keyPress(hwnd, 0x42); 
	}
}
</code></pre>
<p>注意keyPress和mouseClick函数的声明，它有一个关键字native，表明这个方法使用java以外的语言实现。方法不包括实现，因为我们要用c/c++语言实现它</p>

<p>System.loadLibrary(“towerutil”)这句代码，在静态初始化块中定义的，用来装载towerutil.dll动态链接库</p>

<h3 id="section">编译生成头文件</h3>
<p>使用命令javah:</p>

<blockquote>
  <p>javah TowerUtil.java</p>
</blockquote>

<p>文件内容如下:</p>
<pre><code>
/* DO NOT EDIT THIS FILE - it is machine generated */
#include "jni.h"
/* Header for class TowerUtil */

#ifndef _Included_TowerUtil
#define _Included_TowerUtil
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     TowerUtil
 * Method:    keyPress
 * Signature: (II)V
 */
JNIEXPORT void JNICALL Java_TowerUtil_keyPress
  (JNIEnv *, jclass, jint, jint);

/*
 * Class:     TowerUtil
 * Method:    mouseClick
 * Signature: (III)V
 */
JNIEXPORT void JNICALL Java_TowerUtil_mouseClick
  (JNIEnv *, jclass, jint, jint, jint);

#ifdef __cplusplus
}
#endif
#endif
</code></pre>

<h3 id="cc">用c/c++实现函数体</h3>
<p>第三部里定义了keyPress和mouseClick两个函数，接下来要用c语言实现它，注意观察上一步生成的头文件里的函数名和参数，按照其来写
如：</p>

<pre><code>
#include "stdafx.h"
#include "jni.h"
#include "TowerUtil.h"

BOOL APIENTRY DllMain( HANDLE hModule, 
                       DWORD  ul_reason_for_call, 
                       LPVOID lpReserved
					 )
{
    return TRUE;
}
JNIEXPORT void JNICALL Java_TowerUtil_mouseClick
(JNIEnv *env, jobject obj, jint hwnd, jint x, jint y){
	LPARAM lparam = MAKELPARAM(x,y);
	SendMessage((HWND)hwnd, WM_LBUTTONDOWN, MK_LBUTTON, lparam);
	sleep(10);
	SendMessage((HWND)hwnd, WM_LBUTTONUP, MK_LBUTTON, lparam);
	return;
}
JNIEXPORT void JNICALL Java_TowerUtil_keyPress
  (JNIEnv *env, jobject obj, jint hwnd, jint key){
	SendMessage((HWND)hwnd,WM_KEYDOWN,key,0);
	sleep(100);
	SendMessage((HWND)hwnd,WM_KEYUP,key,0);
	return;
}
</code></pre>

<p>关于代码里出现的SendMessage函数:<a href="http://jingyan.baidu.com/article/c45ad29cd5fb58051653e278.html">SendMessage 函数参数大全</a> 的
注意在开头引入jni.h和前面生成的TowerUtil.h</p>
<h3 id="dll">生成dll文件</h3>
<p>下面生成前面提到的 towerutil.dll，windows可以下载MinGW进行编译:</p>

<blockquote>
  <p>gcc -shared TowerUtil.cpp -o towerutil.dll -I （.h头文件目录）</p>
</blockquote>

<h3 id="java-1">运行java程序</h3>
<p>把上面生成的dll文件加入到java.library.path内</p>

<p>main函数里写上一行：</p>

<blockquote>
  <p>TowerUtil.keyPress(hwnd, 0x42);</p>
</blockquote>

<p>解释下， hwnd是我玩的完美国际当前的句柄值，0x42是键盘“b”的asiic值，游戏内b键打开背包
执行后可以看到游戏里的背包界面打开
大功告成！
再结合上一篇文章写到的脚本解析函数的思路，就可以写出一个略微简陋的游戏脚本执行器了
使用JNI的好处上面已提到，脚本编写好后，你可以把游戏最小化，也不影响执行
如果能够再获得游戏内属性基址，就能写出一个功能更丰富的??了</p>


                <hr>

                <ul class="pager">
                    
                    
                    <li class="next">
                        <a href="/blog/2016/01/03/init-blog/" data-toggle="tooltip" data-placement="top" title="博客搬迁">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- Duoshuo Share start -->
                <style>
                    .ds-share{
                        text-align: right;
                    }
                    
                    @media only screen and (max-width: 700px) {
                        .ds-share {

                        }
                    }
                </style>

                <div class="ds-share"
                    data-thread-key="/blog/2015/09/09/use-java-for-game-script" data-title="使用java写个简单游戏脚本（二）：JNI"
                    data-images="cabeza.cn/img/facebook.jpg"
                    data-content="
  上一次的小程序只是演示了一下如何用robot类控制鼠标键盘操作

  这种方法有很大的弊端：1、不能后台运行。2、坐标代码写死，窗口甚至都不可移动。... | Cabeza's blog"
                    data-url="cabeza.cn/blog/2015/09/09/use-java-for-game-script/">
                    <div class="ds-share-inline">
                      <ul  class="ds-share-icons-16">

                        <li data-toggle="ds-share-icons-more"><a class="ds-more" href="#">分享到：</a></li>
                        <li><a class="ds-wechat flat" href="javascript:void(0);" data-service="wechat">微信</a></li>
                        <li><a class="ds-weibo flat" href="javascript:void(0);" data-service="weibo">微博</a></li>
                        <li><a class="ds-douban flat" href="javascript:void(0);" data-service="douban">豆瓣</a></li>
                      </ul>
                      <div class="ds-share-icons-more">
                      </div>
                    </div>
                <hr>
                </div>
                <!-- Duoshuo Share end-->


                <!-- 多说评论框 start -->
                <div class="comment">
                    <div class="ds-thread" data-thread-key="/blog/2015/09/09/use-java-for-game-script" data-title="使用java写个简单游戏脚本（二）：JNI" data-url="cabeza.cn/blog/2015/09/09/use-java-for-game-script/"></div>
                </div>
                <!-- 多说评论框 end -->
            </div>
        </div>
    </div>
</article>



<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"cabeza"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!-- 多说公共JS代码 end -->

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("http://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <!-- kill the Facebook and Weibo -->
					
                    

                    
                    
                    <!--
                    
                    -->

                    <!--
                    
                    -->

                    
                    <!--
                    
                    -->

                </ul>
                <p class="copyright text-muted">
                &copy; 2017  cabeza ❖ Powered by Jekyll.
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


<link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">


</body>

</html>